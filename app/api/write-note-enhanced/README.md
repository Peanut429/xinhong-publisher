# AI 工作流增强版接口

## 概述

这是一个增强版的 AI 工作流接口，解决了原接口中遇到异常就终止任务的问题。新接口实现了完整的重试机制和异常处理，确保在遇到临时性错误时能够自动重试，最终输出需要的结果。

## 主要改进

### 1. 完整的重试机制

- **每个关键步骤都有独立的重试逻辑**
- **最多重试 3 次**，每次间隔 2 秒
- **详细的错误日志记录**，便于调试和监控

### 2. 优雅降级策略

- **多篇笔记备选机制**：如果一篇笔记处理失败，会自动尝试下一篇
- **最多尝试 5 篇笔记**，提高成功率
- **资源保护**：只有在完全成功时才标记原笔记为已使用

### 3. 增强的错误处理

- **详细的错误分类和记录**
- **友好的错误响应格式**
- **处理耗时统计**，便于性能监控

### 4. 详细的日志记录

- **每个步骤的开始和结束都有日志**
- **重试次数和错误信息记录**
- **任务执行耗时统计**

## 接口端点

```
POST /api/write-note-enhanced
```

## 请求参数

```json
{
  "accountId": "用户账号ID",
  "phoneNumber": "手机号"
}
```

## 响应格式

### 成功响应

```json
{
  "success": true,
  "data": {
    "searchResult": {
      /* 搜索结果 */
    },
    "note": {
      /* 使用的原笔记 */
    },
    "articleJson": {
      /* 生成的文章 */
    },
    "sellingPointJson": {
      /* 生成的卖点 */
    },
    "image": "图片URL",
    "taskId": "生成的任务ID"
  },
  "processingTime": 12345,
  "timestamp": "2025-01-01T00:00:00.000Z"
}
```

### 失败响应

```json
{
  "error": "任务处理失败",
  "message": "详细错误信息",
  "processingTime": 12345,
  "timestamp": "2025-01-01T00:00:00.000Z"
}
```

## 重试机制详解

### 1. 数据库获取笔记

- 如果没有可用的笔记，会重试最多 3 次
- 重试间隔 2 秒
- 如果所有重试都失败，返回明确的错误信息

### 2. 搜索关键词生成

- 使用 DeepSeek V3 模型生成搜索关键词
- 如果 JSON 解析失败或生成失败，会重试
- 确保搜索关键词的有效性

### 3. 联网搜索

- 调用外部搜索 API
- 验证搜索结果的有效性
- 如果搜索失败或返回空结果，会重试

### 4. 文章生成

- 基于搜索内容生成小红书风格文章
- 确保文章内容符合要求
- 如果生成失败，会重试

### 5. 卖点生成

- 根据文章内容生成荣威卖点段落
- 确保卖点内容与文章相关
- 如果生成失败，会重试

### 6. 图片生成

- 基于文章标题生成配图
- 使用文本重写服务
- 如果生成失败，会重试

## 配置参数

可以通过修改文件顶部的常量来调整行为：

```typescript
const MAX_RETRIES = 3; // 每个步骤最大重试次数
const RETRY_DELAY = 2000; // 重试间隔时间（毫秒）
const MAX_NOTES_TO_TRY = 5; // 最多尝试的笔记数量
```

## 错误处理策略

### 1. 临时性错误

- 网络超时、API 限流等临时错误
- 会自动重试，间隔递增
- 记录详细的错误日志

### 2. 永久性错误

- 数据库连接失败、权限问题等
- 不会重试，直接返回错误
- 提供清晰的错误信息

### 3. 部分失败

- 如果某篇笔记处理失败，会尝试下一篇
- 只有在所有备选笔记都失败时才返回错误
- 提供每个失败步骤的详细信息

## 监控和调试

### 日志输出

- 控制台日志记录每个步骤的执行情况
- 包含重试次数、耗时等详细信息
- 便于调试和性能分析

### 性能监控

- 记录每个任务的总处理时间
- 统计各个步骤的耗时
- 便于优化和容量规划

## 使用建议

1. **监控日志**：定期检查控制台日志，关注重试频率和失败模式
2. **调整参数**：根据实际使用情况调整重试次数和间隔时间
3. **资源管理**：确保数据库中有足够的可用笔记
4. **错误处理**：客户端应该处理各种可能的错误响应

## 与原接口的对比

| 特性     | 原接口           | 增强版接口           |
| -------- | ---------------- | -------------------- |
| 异常处理 | 遇到异常立即终止 | 自动重试，优雅降级   |
| 资源保护 | 失败时仍占用资源 | 只有成功时才占用资源 |
| 日志记录 | 基本日志         | 详细的执行日志       |
| 容错能力 | 低               | 高                   |
| 成功率   | 依赖单次执行     | 多重保障             |

这个增强版接口显著提高了系统的稳定性和成功率，同时提供了更好的可观察性和调试能力。
